# Чеклист интеграции дашборда в 1С

## Подготовка файлов

### 1. Объединение ресурсов (для 1С)
```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CFO Dashboard</title>
    <style>
        /* Вставить содержимое dashboard.css */
    </style>
</head>
<body>
    <!-- Вставить содержимое dashboard.html body -->
    
    <!-- Инлайн Chart.js (минифицированная версия) -->
    <script>
        /* Содержимое Chart.js 3.9.1 */
    </script>
    
    <!-- Основной код дашборда -->
    <script>
        /* Содержимое dashboard.js */
    </script>
</body>
</html>
```

### 2. Размещение в 1С
- Путь: `ОбщиеМакеты.CFODashboard.Макет`
- Тип: `HTML документ`
- Кодировка: `UTF-8`

## Код 1С для встраивания

### 1. Создание формы с HTMLПолем
```bsl
// В модуле формы
&НаКлиенте
Процедура ПриСозданииНаКлиенте()
    ОбновитьДашборд();
КонецПроцедуры

&НаКлиенте  
Процедура ОбновитьДашборд()
    СтрокаHTML = ПолучитьHTMLДашборда();
    HTMLПоле.УстановитьТекст(СтрокаHTML);
КонецПроцедуры

&НаСервере
Функция ПолучитьHTMLДашборда()
    Макет = Обработки.CFOДашборд.ПолучитьМакет("Dashboard");
    Возврат Макет.ПолучитьТекст();
КонецФункции
```

### 2. Передача данных в дашборд
```bsl
&НаКлиенте
Процедура ОбновитьДанныеДашборда()
    ДанныеJSON = ПолучитьДанныеДашбордаJSON();
    
    СтрокаВыполнения = "
    |try {
    |    window.external1C.updateDashboard(" + ДанныеJSON + ");
    |    'success';
    |} catch(e) {
    |    'error: ' + e.message;
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(СтрокаВыполнения);
    
    Если Лев(Результат, 5) = "error" Тогда
        Сообщить("Ошибка обновления дашборда: " + Результат);
    КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПолучитьДанныеДашбордаJSON()
    СтруктураДанных = Новый Структура;
    
    // Мета-информация
    СтруктураДанных.Вставить("meta", Новый Структура(
        "period", ТекущаяДата(),
        "currency", "RUB",
        "company", "ООО Прогресс"
    ));
    
    // KPI
    KPI = Новый Структура;
    
    // Выручка
    ВыручкаСтруктура = Новый Структура(
        "current", ПолучитьВыручкуТекущийМесяц(),
        "momChange", РассчитатьИзменениеMoM(),
        "yoyChange", РассчитатьИзменениеYoY()
    );
    KPI.Вставить("revenue", ВыручкаСтруктура);
    
    KPI.Вставить("ebitda", ПолучитьEBITDA());
    KPI.Вставить("ocf", ПолучитьOCF());
    KPI.Вставить("cashEnd", ПолучитьОстатокДенежныхСредств());
    KPI.Вставить("cashRunwayMonths", РассчитатьCashRunway());
    
    // Маржи
    МаржиСтруктура = Новый Структура(
        "gross", РассчитатьВаловуюМаржу(),
        "ebitda", РассчитатьМаржуEBITDA(),
        "net", РассчитатьЧистуюМаржу()
    );
    KPI.Вставить("margins", МаржиСтруктура);
    
    СтруктураДанных.Вставить("kpi", KPI);
    
    // Временные ряды
    ВременныеРяды = Новый Структура;
    
    // Выручка по периодам
    ВыручкаРяд = Новый Структура(
        "fact", ПолучитьВыручкуПоПериодам("Факт"),
        "plan", ПолучитьВыручкуПоПериодам("План"),
        "prevYear", ПолучитьВыручкуПоПериодам("ПрошлыйГод"),
        "forecast", ПолучитьПрогнозВыручки(),
        "dates", ПолучитьМассивДат()
    );
    ВременныеРяды.Вставить("revenue", ВыручкаРяд);
    
    // Остальные временные ряды...
    
    СтруктураДанных.Вставить("timeSeries", ВременныеРяды);
    
    // Преобразование в JSON
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, СтруктураДанных);
    
    Возврат ЗаписьJSON.Закрыть();
КонецФункции
```

### 3. Функции расчета метрик
```bsl
&НаСервере
Функция РассчитатьDSO()
    // DSO = (Дебиторская задолженность / Выручка) × 365
    ДебиторскаяЗадолженность = ПолучитьДебиторскуюЗадолженность();
    ВыручкаГод = ПолучитьВыручкуЗаГод();
    
    Если ВыручкаГод = 0 Тогда
        Возврат 0;
    КонецЕсли;
    
    Возврат (ДебиторскаяЗадолженность / ВыручкаГод) * 365;
КонецФункции

&НаСервере
Функция РассчитатьCashRunway()
    // Количество месяцев, на которые хватит текущего cash при текущем burn rate
    ОстатокДенег = ПолучитьОстатокДенежныхСредств();
    СреднемесячныйOCF = ПолучитьСреднемесячныйOCF();
    
    Если СреднемесячныйOCF <= 0 Тогда
        Возврат 999; // Бесконечность если OCF положительный
    КонецЕсли;
    
    Возврат ОстатокДенег / СреднемесячныйOCF;
КонецФункции

&НаСервере
Функция РассчитатьCCC()
    // CCC = DSO + DII - DPO
    DSO = РассчитатьDSO();
    DII = РассчитатьDII(); // Days Inventory Outstanding
    DPO = РассчитатьDPO(); // Days Payable Outstanding
    
    Возврат DSO + DII - DPO;
КонецФункции
```

## Диагностика и отладка

### 1. Проверка загрузки HTML
```bsl
&НаКлиенте
Процедура ПроверитьЗагрузкуHTML()
    СтрокаПроверки = "
    |try {
    |    if (typeof window.external1C !== 'undefined') {
    |        'API доступен';
    |    } else {
    |        'API не найден';
    |    }
    |} catch(e) {
    |    'Ошибка: ' + e.message;
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(СтрокаПроверки);
    Сообщить("Статус API: " + Результат);
КонецПроцедуры
```

### 2. Проверка состояния дашборда
```bsl
&НаКлиенте
Процедура ПроверитьСостояниеДашборда()
    СтрокаПроверки = "
    |try {
    |    const state = window.external1C.getDashboardState();
    |    JSON.stringify(state);
    |} catch(e) {
    |    'Ошибка: ' + e.message;
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(СтрокаПроверки);
    Сообщить("Состояние дашборда: " + Результат);
КонецПроцедуры
```

### 3. Обработка ошибок
```bsl
&НаКлиенте
Процедура ОбработатьОшибкуHTML(Ошибка)
    ТекстОшибки = "Ошибка в HTML поле: " + Ошибка.Описание;
    
    Если Найти(ВРег(Ошибка.Описание), "SCRIPT") > 0 Тогда
        ТекстОшибки = ТекстОшибки + Символы.ПС + 
            "Возможные причины:" + Символы.ПС +
            "1. Ошибка в JavaScript коде" + Символы.ПС +
            "2. Несовместимость с версией WebKit" + Символы.ПС +
            "3. Неверный формат JSON данных";
    КонецЕсли;
    
    Сообщить(ТекстОшибки);
    ЗаписатьВЖурналРегистрации("CFO.Dashboard.Error", 
        УровеньЖурналаРегистрации.Ошибка, , , ТекстОшибки);
КонецПроцедуры
```

## Новые API методы (Sprint 3)

### 1. Управление фильтрами

#### Установка фильтров из 1С
```bsl
&НаКлиенте
Процедура УстановитьФильтрыДашборда()
    ФильтрыСтруктура = Новый Структура;
    ФильтрыСтруктура.Вставить("company", "progress");
    ФильтрыСтруктура.Вставить("periodPreset", "quarter");
    ФильтрыСтруктура.Вставить("dateFrom", "2024-10-01");
    ФильтрыСтруктура.Вставить("dateTo", "2024-12-31");
    ФильтрыСтруктура.Вставить("showForecast", Ложь);
    ФильтрыСтруктура.Вставить("percentageMode", Истина);
    
    ФильтрыJSON = СериализоватьВJSON(ФильтрыСтруктура);
    
    КомандаJS = "
    |try {
    |    const result = window.external1C.setFilters('" + ФильтрыJSON + "');
    |    JSON.stringify(result);
    |} catch(e) {
    |    JSON.stringify({success: false, error: e.message});
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    РезультатОбъект = РазобратьJSONСтроку(Результат);
    
    Если РезультатОбъект.success Тогда
        Сообщить("Фильтры применены успешно");
    Иначе
        Сообщить("Ошибка применения фильтров: " + РезультатОбъект.message);
    КонецЕсли;
КонецПроцедуры
```

#### Получение текущих фильтров
```bsl
&НаКлиенте
Процедура ПолучитьТекущиеФильтры()
    КомандаJS = "
    |try {
    |    window.external1C.getFilters();
    |} catch(e) {
    |    JSON.stringify({error: e.message});
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    ФильтрыОбъект = РазобратьJSONСтроку(Результат);
    
    Сообщить("Текущие фильтры: " + Результат);
КонецПроцедуры
```

### 2. Экспорт дашборда в PNG

```bsl
&НаКлиенте  
Процедура ЭкспортироватьДашбордВPNG()
    КомандаJS = "
    |window.external1C.exportPNG().then(result => {
    |    if (result.success) {
    |        // result.dataURL содержит base64 PNG
    |        window._exportResult = result;
    |        'success';
    |    } else {
    |        'error: ' + result.message;
    |    }
    |});";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    
    Если Результат = "success" Тогда
        // Получаем результат экспорта
        КомандаПолучения = "JSON.stringify(window._exportResult)";
        РезультатЭкспорта = HTMLПоле.ВыполнитьJavaScript(КомандаПолучения);
        ДанныеЭкспорта = РазобратьJSONСтроку(РезультатЭкспорта);
        
        // Сохраняем PNG файл
        СохранитьPNGИзBase64(ДанныеЭкспорта.dataURL);
        Сообщить("Дашборд экспортирован в PNG");
    Иначе
        Сообщить("Ошибка экспорта: " + Результат);
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура СохранитьPNGИзBase64(Base64Data)
    // Убираем префикс data:image/png;base64,
    ЧистыйBase64 = СтрЗаменить(Base64Data, "data:image/png;base64,", "");
    
    // Преобразуем в двоичные данные
    ДвоичныеДанные = Base64Значение(ЧистыйBase64);
    
    // Сохраняем файл
    ИмяФайла = "CFO_Dashboard_" + Формат(ТекущаяДата(), "ДФ=ггММдд_ЧЧммсс") + ".png";
    ПутьФайла = КаталогВременныхФайлов() + ИмяФайла;
    
    ДвоичныеДанные.Записать(ПутьФайла);
    
    // Показываем пользователю
    ЗапуститьПриложение(ПутьФайла);
КонецПроцедуры
```

### 3. Снапшот KPI для отчетов

```bsl
&НаКлиенте
Процедура ПолучитьСнапшотKPI()
    КомандаJS = "
    |try {
    |    window.external1C.getKPISnapshot();
    |} catch(e) {
    |    JSON.stringify({error: e.message});
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    СнапшотОбъект = РазобратьJSONСтроку(Результат);
    
    Если СнапшотОбъект.Свойство("error") Тогда
        Сообщить("Ошибка получения KPI: " + СнапшотОбъект.error);
        Возврат;
    КонецЕсли;
    
    // Используем данные для отчетов
    СоздатьОтчетПоKPI(СнапшотОбъект);
КонецПроцедуры

&НаКлиенте  
Процедура СоздатьОтчетПоKPI(Данные)
    Отчет = "=== СНАПШОТ CFO DASHBOARD ===\n";
    Отчет = Отчет + "Период: " + Данные.period + "\n";
    Отчет = Отчет + "Компания: " + Данные.company + "\n\n";
    
    Отчет = Отчет + "КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ:\n";
    Отчет = Отчет + "Выручка: " + Формат(Данные.kpi.revenue / 1000000, "ЧЦ=15; ЧДЦ=1") + " млн ₽\n";
    Отчет = Отчет + "EBITDA: " + Формат(Данные.kpi.ebitda / 1000000, "ЧЦ=15; ЧДЦ=1") + " млн ₽\n";
    Отчет = Отчет + "Cash Runway: " + Формат(Данные.kpi.cashRunwayMonths, "ЧЦ=15; ЧДЦ=1") + " мес\n\n";
    
    Отчет = Отчет + "ФИНАНСОВЫЕ КОЭФФИЦИЕНТЫ:\n";
    Отчет = Отчет + "DSO: " + Формат(Данные.coefficients.dso, "ЧЦ=15; ЧДЦ=0") + " дн.\n";
    Отчет = Отчет + "DPO: " + Формат(Данные.coefficients.dpo, "ЧЦ=15; ЧДЦ=0") + " дн.\n";
    Отчет = Отчет + "CCC: " + Формат(Данные.coefficients.ccc, "ЧЦ=15; ЧДЦ=0") + " дн.\n\n";
    
    Если Данные.alerts.Количество() > 0 Тогда
        Отчет = Отчет + "АКТИВНЫЕ АЛЕРТЫ:\n";
        Для Каждого Алерт Из Данные.alerts Цикл
            Отчет = Отчет + "- " + Алерт.severity + ": " + Алерт.message + "\n";
        КонецЦикла;
    Иначе
        Отчет = Отчет + "Активных алертов нет\n";
    КонецЕсли;
    
    // Сохраняем отчет
    ИмяФайла = "KPI_Snapshot_" + Формат(ТекущаяДата(), "ДФ=ггММдд_ЧЧммсс") + ".txt";
    ПутьФайла = КаталогВременныхФайлов() + ИмяФайла;
    
    ТекстовыйФайл = Новый ЗаписьТекста(ПутьФайла, КодировкаТекста.UTF8);
    ТекстовыйФайл.Записать(Отчет);
    ТекстовыйФайл.Закрыть();
    
    ЗапуститьПриложение(ПутьФайла);
КонецПроцедуры
```

### 4. Комплексное обновление с валидацией

```bsl
&НаКлиенте
Процедура ОбновитьДашбордСВалидацией()
    ДанныеJSON = ПолучитьДанныеДашбордаJSON();
    
    КомандаJS = "
    |try {
    |    const result = window.external1C.updateDashboard(" + ДанныеJSON + ");
    |    JSON.stringify(result);
    |} catch(e) {
    |    JSON.stringify({success: false, error: e.message});
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    РезультатОбъект = РазобратьJSONСтроку(Результат);
    
    Если РезультатОбъект.success Тогда
        // Проверяем результаты валидации
        Если РезультатОбъект.Свойство("validation") Тогда
            Валидация = РезультатОбъект.validation;
            
            Если НЕ Валидация.valid И Валидация.errors.Количество() > 0 Тогда
                ТекстОшибок = "";
                Для Каждого Ошибка Из Валидация.errors Цикл
                    ТекстОшибок = ТекстОшибок + "- " + Ошибка + Символы.ПС;
                КонецЦикла;
                
                Предупреждение("Найдены ошибки в данных:" + Символы.ПС + ТекстОшибок);
            КонецЕсли;
            
            Если Валидация.warnings.Количество() > 0 Тогда
                ТекстПредупреждений = "";
                Для Каждого Предупреждение Из Валидация.warnings Цикл
                    ТекстПредупреждений = ТекстПредупреждений + "- " + Предупреждение + Символы.ПС;
                КонецЦикла;
                
                // Логируем предупреждения
                ЗаписатьВЖурналРегистрации("CFO.Dashboard.Validation", 
                    УровеньЖурналаРегистрации.Предупреждение, , , 
                    "Предупреждения валидации:" + Символы.ПС + ТекстПредупреждений);
            КонецЕсли;
        КонецЕсли;
        
        Сообщить("Дашборд обновлен успешно");
    Иначе
        Сообщить("Ошибка обновления: " + РезультатОбъект.error);
    КонецЕсли;
КонецПроцедуры
```

### 5. Пример интеграции с автоматической отправкой отчетов

```bsl
&НаКлиенте
Процедура ОтправитьKPIПоПочте()
    // Получаем снапшот
    КомандаJS = "window.external1C.getKPISnapshot()";
    РезультатJSON = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    Данные = РазобратьJSONСтроку(РезультатJSON);
    
    // Экспортируем PNG
    КомандаЭкспорта = "
    |window.external1C.exportPNG().then(result => {
    |    window._pngData = result.dataURL;
    |    'ready';
    |});";
    
    РезультатЭкспорта = HTMLПоле.ВыполнитьJavaScript(КомандаЭкспорта);
    
    Если РезультатЭкспорта = "ready" Тогда
        // Получаем PNG данные
        PNGData = HTMLПоле.ВыполнитьJavaScript("window._pngData");
        
        // Формируем письмо
        СоздатьИОтправитьОтчетПоПочте(Данные, PNGData);
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура СоздатьИОтправитьОтчетПоПочте(КПИДанные, PNGBase64)
    // Создаем новое письмо
    ПисьмоОбъект = Новый ИнтернетПочтовоеСообщение;
    ПисьмоОбъект.Тема = "CFO Dashboard - " + КПИДанные.period;
    
    // Формируем тело письма
    ТекстПисьма = "
    |Автоматический отчет CFO Dashboard
    |
    |Период: " + КПИДанные.period + "
    |Компания: " + КПИДанные.company + "
    |
    |КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ:
    |• Выручка: " + Формат(КПИДанные.kpi.revenue/1000000, "ЧДЦ=1") + " млн ₽
    |• EBITDA: " + Формат(КПИДанные.kpi.ebitda/1000000, "ЧДЦ=1") + " млн ₽  
    |• Cash Runway: " + Формат(КПИДанные.kpi.cashRunwayMonths, "ЧДЦ=1") + " мес
    |
    |ФИНАНСОВЫЕ КОЭФФИЦИЕНТЫ:
    |• DSO: " + КПИДанные.coefficients.dso + " дн.
    |• CCC: " + КПИДанные.coefficients.ccc + " дн.
    |
    |См. детальный дашборд во вложении.
    |
    |---
    |Автоматически создано системой 1С
    |";
    
    ПисьмоОбъект.Тексты.Добавить(ТекстПисьма);
    
    // Добавляем PNG как вложение
    ЧистыйBase64 = СтрЗаменить(PNGBase64, "data:image/png;base64,", "");
    ДвоичныеДанные = Base64Значение(ЧистыйBase64);
    
    ВременныйФайл = КаталогВременныхФайлов() + "dashboard.png";
    ДвоичныеДанные.Записать(ВременныйФайл);
    
    ПисьмоОбъект.Вложения.Добавить(ВременныйФайл);
    
    // Отправляем
    ОтправитьПисьмо(ПисьмоОбъект);
КонецПроцедуры
```

## Объединение ресурсов (обновлено)

Теперь дашборд использует единый оффлайн бандл `dashboard.bundle.js` вместо CDN:

```html
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CFO Dashboard</title>
    <style>
        /* Весь CSS инлайн */
    </style>
</head>
<body>
    <!-- HTML содержимое -->
    
    <!-- Единственный скрипт -->
    <script src="./dashboard.bundle.js"></script>
    <script>
        /* Основной код дашборда */
    </script>
</body>
</html>
```

## Оптимизация производительности

### 1. Кеширование HTML
```bsl
&НаСервере
Функция ПолучитьHTMLДашбордаСКешем()
    ИмяПеременной = "CFODashboard_HTML_Cache";
    
    HTML = ПараметрыСеанса[ИмяПеременной];
    Если HTML = Неопределено Тогда
        Макет = Обработки.CFOДашборд.ПолучитьМакет("Dashboard");
        HTML = Макет.ПолучитьТекст();
        ПараметрыСеанса.Вставить(ИмяПеременной, HTML);
    КонецЕсли;
    
    Возврат HTML;
КонецФункции
```

### 2. Асинхронное обновление данных
```bsl
&НаКлиенте
Процедура ОбновитьДашбордАсинхронно()
    ПодключитьОбработчикОжидания("ВыполнитьОбновлениеДанных", 0.1, Истина);
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьОбновлениеДанных()
    Попытка
        ОбновитьДанныеДашборда();
    Исключение
        ОбработатьОшибкуHTML(ИнформацияОбОшибке());
    КонецПопытки;
КонецПроцедуры
```

## Требования к версии 1С

- **Минимальная версия**: 1С 8.3.27
- **Поддержка**: HTMLПоле, ВыполнитьJavaScript
- **WebKit**: V8WebKit версии 8.3.27+

## Тестирование

### 1. Модульные тесты
```bsl
&НаСервере
Процедура ТестРасчетаDSO()
    // Подготовка тестовых данных
    УстановитьТестовыеДанные();
    
    // Выполнение
    Результат = РассчитатьDSO();
    
    // Проверка
    ОжидаемыйРезультат = 47;
    Если Окр(Результат, 0) <> ОжидаемыйРезультат Тогда
        ВызватьИсключение("DSO рассчитан неверно");
    КонецЕсли;
КонецПроцедуры
```

### 2. Интеграционные тесты
```bsl
&НаКлиенте
Процедура ТестОбновленияДашборда()
    // Подготовка
    ОбновитьДашборд();
    
    // Выполнение
    ОбновитьДанныеДашборда();
    
    // Проверка
    Состояние = ПроверитьСостояниеДашборда();
    Если Найти(Состояние, "error") > 0 Тогда
        ВызватьИсключение("Ошибка обновления дашборда: " + Состояние);
    КонецЕсли;
КонецПроцедуры
```

## Sprint 5 - Новые возможности BSL

### Управление ролями пользователей
```bsl
&НаКлиенте
Процедура УстановитьРольПользователя(РольПользователя)
    // Доступные роли: "CEO", "CFO", "Sales"
    СтрокаВызова = "window.external1C.setRole('" + РольПользователя + "')";
    
    Попытка
        РезультатJSON = HTMLПоле.ВыполнитьJavaScript(СтрокаВызова);
        Результат = ПрочитатьJSON(РезультатJSON);
        
        Если Результат.success Тогда
            Сообщить("Роль " + РольПользователя + " установлена успешно");
        Иначе
            Сообщить("Ошибка установки роли: " + Результат.message);
        КонецЕсли;
        
    Исключение
        Сообщить("Ошибка вызова setRole: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

&НаКлиенте  
Функция ПолучитьТекущуюРоль()
    ТекущаяРоль = HTMLПоле.ВыполнитьJavaScript("window.external1C.getRole()");
    Возврат ТекущаяРоль;
КонецФункции
```

### Настройка кэш-прогноза
```bsl
&НаКлиенте
Процедура НастроитьКэшПрогноз()
    ПараметрыПрогноза = Новый Структура;
    ПараметрыПрогноза.Вставить("scenarioWeights", Новый Структура("base", 1.0, "optimistic", 1.15, "pessimistic", 0.85));
    ПараметрыПрогноза.Вставить("seasonalAdjustment", Истина);
    ПараметрыПрогноза.Вставить("includeFixedCosts", Истина);
    
    JsonПараметры = ЗаписатьJSON(ПараметрыПрогноза);
    СтрокаВызова = "window.external1C.setForecastParams('" + JsonПараметры + "')";
    
    РезультатJSON = HTMLПоле.ВыполнитьJavaScript(СтрокаВызова);
    Результат = ПрочитатьJSON(РезультатJSON);
    
    Если Результат.success Тогда
        Сообщить("Параметры кэш-прогноза настроены");
    КонецЕсли;
КонецПроцедуры
```

### Улучшенный экспорт PNG
```bsl  
&НаКлиенте
Процедура ЭкспортироватьСтраницуПолный()
    СтрокаВызова = "window.external1C.exportCurrentPagePNG()";
    
    РезультатJSON = HTMLПоле.ВыполнитьJavaScript(СтрокаВызова);
    Результат = ПрочитатьJSON(РезультатJSON);
    
    Если Результат.success Тогда
        ИмяФайла = "cfo_dashboard_" + Результат.pageName + "_" + Формат(ТекущаяДата(), "ДФ=yyyyMMdd_HHmmss") + ".png";
        ДвоичныеДанные = Base64Значение(Результат.data);
        ДвоичныеДанные.Записать(ИмяФайла);
        
        Сообщить("Экспортирована страница: " + ИмяФайла);
        Сообщить("Размер: " + Результат.width + "×" + Результат.height + "px");
    КонецЕсли;
КонецПроцедуры
```

---

## Sprint 6.1 Stabilization - Обновления API

### Изменения в архитектуре после S6.1

**Ключевые изменения стабилизации:**
1. **Удалены дубли функций** - теперь `ensureHiDPI`, печать/экспорт доступны только через единые глобальные функции
2. **Динамическая высота header** - CSS переменная `--header-h` автоматически рассчитывается
3. **Единая инициализация** - все компоненты инициализируются через один `DOMContentLoaded` обработчик
4. **Улучшенный мини-линтер** - теперь проверяет дубли ID и функций в runtime

### Новые глобальные функции (Sprint 6.1)

После стабилизации все ключевые функции доступны в `window` объекте:

```javascript
// Печать и экспорт - теперь глобальные
window.printCurrentPage()      // Печать текущей страницы
window.printAllPages()         // Печать всех страниц
window.exportCurrentPage()     // Экспорт текущей страницы в PNG
window.exportAllPages()        // Экспорт всех страниц
window.executeBatchExport()    // Batch экспорт с манифестом

// Управление алертами
window.hideRecommendationBanner()
window.snoozeRecommendationBanner()
window.snoozeAlert()
window.jumpToAlertSource()
window.dismissAlert()
```

### Обновленная диагностика (S6.1)

```bsl
&НаКлиенте
Процедура ПроверитьСтабилизациюS61()
    // Проверяем отсутствие дублей функций
    КомандаJS = "
    |try {
    |    const lintResult = window.__dbg.selfCheck();
    |    JSON.stringify(lintResult);
    |} catch(e) {
    |    JSON.stringify({errors: ['selfCheck failed: ' + e.message]});
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    РезультатОбъект = РазобратьJSONСтроку(Результат);
    
    Если РезультатОбъект.errors.Количество() > 0 Тогда
        ТекстОшибок = "";
        Для Каждого Ошибка Из РезультатОбъект.errors Цикл
            ТекстОшибок = ТекстОшибок + "- " + Ошибка + Символы.ПС;
        КонецЦикла;
        
        Предупреждение("Обнаружены проблемы после S6.1:" + Символы.ПС + ТекстОшибок);
    Иначе
        Сообщить("Стабилизация S6.1 прошла успешно. Ошибок: 0");
    КонецЕсли;
КонецПроцедуры
```

### Проверка динамической высоты header

```bsl
&НаКлиенте
Процедура ПроверитьВысотуHeader()
    КомандаJS = "
    |try {
    |    const headerHeight = getComputedStyle(document.documentElement)
    |        .getPropertyValue('--header-h');
    |    'Высота header: ' + headerHeight;
    |} catch(e) {
    |    'Ошибка получения высоты: ' + e.message;
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    Сообщить(Результат);
КонецПроцедуры
```

### Обновленный вызов печати из 1С

```bsl
&НаКлиенте
Процедура ПечатьТекущейСтраницы()
    // После S6.1 - прямой вызов глобальной функции
    КомандаJS = "
    |try {
    |    window.printCurrentPage();
    |    'Печать запущена успешно';
    |} catch(e) {
    |    'Ошибка печати: ' + e.message;
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    
    Если Найти(Результат, "Ошибка") = 0 Тогда
        Сообщить("Печать дашборда запущена");
    Иначе
        Сообщить(Результат);
    КонецЕсли;
КонецПроцедуры
```

### Пример интеграции с централизованным applyShareMode

```bsl
&НаКлиенте
Процедура ПереключитьРежимАбсолютПроцент()
    // Получаем текущий режим
    КомандаПолучения = "localStorage.getItem('dash.mode.share') || 'absolute'";
    ТекущийРежим = HTMLПоле.ВыполнитьJavaScript(КомандаПолучения);
    
    // Переключаем режим
    НовыйРежим = ?(ТекущийРежим = "absolute", "percentage", "absolute");
    
    КомандаПереключения = "
    |try {
    |    if (typeof applyShareMode === 'function') {
    |        applyShareMode('" + НовыйРежим + "');
    |        'Режим переключен на: " + НовыйРежим + "';
    |    } else {
    |        'Функция applyShareMode недоступна';
    |    }
    |} catch(e) {
    |    'Ошибка переключения: ' + e.message;
    |}";
    
    Результат = HTMLПоле.ВыполнитьJavaScript(КомандаПереключения);
    Сообщить(Результат);
КонецПроцедуры
```

### Контроль версий и совместимость

**V8WebKit требования после S6.1:**
- Минимальная версия: V8WebKit 8.3.27
- Поддержка CSS переменных (--header-h)
- Поддержка performance.mark/measure API
- Совместимость с IIFE bundling pattern

**Проверка совместимости:**
```bsl
&НаКлиенте
Процедура ПроверитьСовместимостьWebKit()
    КомандаJS = "
    |const features = {
    |    cssVariables: !!window.CSS && CSS.supports('color', 'var(--test)'),
    |    performance: !!window.performance && !!performance.mark,
    |    iife: true,
    |    webkit: navigator.userAgent.includes('WebKit')
    |};
    |JSON.stringify(features);";
    
    РезультатJSON = HTMLПоле.ВыполнитьJavaScript(КомандаJS);
    Возможности = РазобратьJSONСтроку(РезультатJSON);
    
    Если НЕ Возможности.cssVariables Тогда
        Предупреждение("CSS переменные не поддерживаются - header высота может работать некорректно");
    КонецЕсли;
    
    Если НЕ Возможности.performance Тогда
        Предупреждение("Performance API недоступен - метрики производительности отключены");
    КонецЕсли;
КонецПроцедуры
```