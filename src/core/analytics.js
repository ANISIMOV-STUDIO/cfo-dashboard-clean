/**
 * Advanced Analytics and Forecasting Module
 * Provides trend analysis, predictions, and business insights
 * Compatible with V8WebKit 8.3.27
 */
(function() {
    'use strict';
    
    var AdvancedAnalytics = {
        analysisCache: {},
        forecastCache: {},
        alertThresholds: {
            revenueDecline: 0.05, // 5% decline
            marginDrop: 0.02,     // 2% points
            cashLow: 30,          // 30 days runway
            arHigh: 45            // 45 days DSO
        },
        
        // Initialize analytics module
        initialize: function() {
            this.setupAnalyticsUI();
            this.bindAnalyticsEvents();
            this.startPeriodicAnalysis();
        },
        
        // Setup analytics UI elements
        setupAnalyticsUI: function() {
            this.createAnalyticsButton();
            this.createAnalyticsPanel();
            this.addTrendIndicators();
        },
        
        // Create analytics button in toolbar
        createAnalyticsButton: function() {\n            var button = document.createElement('button');\n            button.id = 'analytics-btn';\n            button.className = 'analytics-btn';\n            button.innerHTML = 'üìä';\n            button.title = '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã';\n            \n            var interactionStatus = document.querySelector('.interaction-status');\n            if (interactionStatus) {\n                interactionStatus.insertBefore(button, interactionStatus.children[2]);\n            }\n        },\n        \n        // Create analytics panel\n        createAnalyticsPanel: function() {\n            var panel = document.createElement('div');\n            panel.id = 'analytics-panel';\n            panel.className = 'analytics-panel';\n            panel.style.display = 'none';\n            \n            panel.innerHTML = `\n                <div class=\"analytics-header\">\n                    <h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</h3>\n                    <button class=\"close-btn\" onclick=\"this.closest('#analytics-panel').style.display='none'\">√ó</button>\n                </div>\n                <div class=\"analytics-content\">\n                    <div class=\"analytics-tabs\">\n                        <button class=\"analytics-tab active\" data-tab=\"insights\">–ò–Ω—Å–∞–π—Ç—ã</button>\n                        <button class=\"analytics-tab\" data-tab=\"forecasts\">–ü—Ä–æ–≥–Ω–æ–∑—ã</button>\n                        <button class=\"analytics-tab\" data-tab=\"correlations\">–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏</button>\n                        <button class=\"analytics-tab\" data-tab=\"alerts\">–†–∏—Å–∫–∏</button>\n                    </div>\n                    <div class=\"analytics-tab-content\">\n                        <div id=\"insights-content\" class=\"analytics-section active\">\n                            <div id=\"insights-list\">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</div>\n                        </div>\n                        <div id=\"forecasts-content\" class=\"analytics-section\">\n                            <div id=\"forecasts-list\">–°—Ç—Ä–æ–∏–º –ø—Ä–æ–≥–Ω–æ–∑—ã...</div>\n                        </div>\n                        <div id=\"correlations-content\" class=\"analytics-section\">\n                            <div id=\"correlations-list\">–ò—â–µ–º —Å–≤—è–∑–∏...</div>\n                        </div>\n                        <div id=\"alerts-content\" class=\"analytics-section\">\n                            <div id=\"alerts-list\">–û—Ü–µ–Ω–∏–≤–∞–µ–º —Ä–∏—Å–∫–∏...</div>\n                        </div>\n                    </div>\n                </div>\n            `;\n            \n            document.body.appendChild(panel);\n        },\n        \n        // Add trend indicators to KPI cards\n        addTrendIndicators: function() {\n            var kpiCards = document.querySelectorAll('.kpi-card');\n            \n            kpiCards.forEach(function(card) {\n                var trendIndicator = document.createElement('div');\n                trendIndicator.className = 'trend-indicator';\n                trendIndicator.innerHTML = 'üìà';\n                trendIndicator.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–∞';\n                \n                card.style.position = 'relative';\n                card.appendChild(trendIndicator);\n            });\n        },\n        \n        // Bind analytics events\n        bindAnalyticsEvents: function() {\n            var self = this;\n            \n            // Analytics button click\n            document.addEventListener('click', function(event) {\n                if (event.target.id === 'analytics-btn') {\n                    var panel = document.getElementById('analytics-panel');\n                    if (panel.style.display === 'none') {\n                        panel.style.display = 'block';\n                        self.runFullAnalysis();\n                    } else {\n                        panel.style.display = 'none';\n                    }\n                }\n                \n                // Analytics tabs\n                if (event.target.classList.contains('analytics-tab')) {\n                    self.switchAnalyticsTab(event.target.getAttribute('data-tab'));\n                }\n                \n                // Trend indicators\n                if (event.target.classList.contains('trend-indicator')) {\n                    var card = event.target.closest('.kpi-card');\n                    self.showTrendAnalysis(card);\n                }\n            });\n            \n            // Listen for data updates to refresh analysis\n            window.addEventListener('dataUpdated', function() {\n                self.invalidateCache();\n                if (document.getElementById('analytics-panel').style.display === 'block') {\n                    self.runFullAnalysis();\n                }\n            });\n        },\n        \n        // Switch analytics tab\n        switchAnalyticsTab: function(tabName) {\n            // Update tab buttons\n            var tabs = document.querySelectorAll('.analytics-tab');\n            tabs.forEach(function(tab) {\n                tab.classList.remove('active');\n            });\n            document.querySelector('[data-tab=\"' + tabName + '\"]').classList.add('active');\n            \n            // Update content\n            var sections = document.querySelectorAll('.analytics-section');\n            sections.forEach(function(section) {\n                section.classList.remove('active');\n            });\n            document.getElementById(tabName + '-content').classList.add('active');\n            \n            // Load content for the tab\n            switch (tabName) {\n                case 'insights':\n                    this.loadInsights();\n                    break;\n                case 'forecasts':\n                    this.loadForecasts();\n                    break;\n                case 'correlations':\n                    this.loadCorrelations();\n                    break;\n                case 'alerts':\n                    this.loadRiskAlerts();\n                    break;\n            }\n        },\n        \n        // Run full analysis\n        runFullAnalysis: function() {\n            this.loadInsights();\n            this.loadForecasts();\n            this.loadCorrelations();\n            this.loadRiskAlerts();\n        },\n        \n        // Load business insights\n        loadInsights: function() {\n            var data = window.DataManager ? window.DataManager.getData() : null;\n            if (!data) return;\n            \n            var insights = this.generateInsights(data);\n            var container = document.getElementById('insights-list');\n            \n            container.innerHTML = insights.map(function(insight) {\n                var iconClass = insight.type === 'positive' ? 'üìà' : \n                               insight.type === 'negative' ? 'üìâ' : 'üí°';\n                               \n                return `\n                    <div class=\"insight-item ${insight.type}\">\n                        <div class=\"insight-icon\">${iconClass}</div>\n                        <div class=\"insight-content\">\n                            <div class=\"insight-title\">${insight.title}</div>\n                            <div class=\"insight-description\">${insight.description}</div>\n                            <div class=\"insight-impact\">–í–ª–∏—è–Ω–∏–µ: ${insight.impact}</div>\n                        </div>\n                    </div>\n                `;\n            }).join('');\n        },\n        \n        // Generate business insights\n        generateInsights: function(data) {\n            var insights = [];\n            \n            if (data.kpi) {\n                // Revenue insights\n                if (data.kpi.revenue && data.kpi.revenue.momChange) {\n                    var revenueChange = data.kpi.revenue.momChange;\n                    if (revenueChange > 10) {\n                        insights.push({\n                            type: 'positive',\n                            title: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–æ—Å—Ç–∞ –≤—ã—Ä—É—á–∫–∏',\n                            description: `–í—ã—Ä—É—á–∫–∞ —Ä–∞—Å—Ç—ë—Ç –Ω–∞ ${revenueChange.toFixed(1)}% –º/–º, —á—Ç–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–ª–∞–Ω–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏.`,\n                            impact: '–í—ã—Å–æ–∫–æ–µ'\n                        });\n                    } else if (revenueChange < -5) {\n                        insights.push({\n                            type: 'negative',\n                            title: '–°–Ω–∏–∂–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏',\n                            description: `–í—ã—Ä—É—á–∫–∞ —Å–Ω–∏–∑–∏–ª–∞—Å—å –Ω–∞ ${Math.abs(revenueChange).toFixed(1)}% –º/–º. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã.`,\n                            impact: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ'\n                        });\n                    }\n                }\n                \n                // Margin insights\n                if (data.kpi.margins && data.kpi.margins.ebitda) {\n                    var margin = data.kpi.margins.ebitda;\n                    if (margin > 25) {\n                        insights.push({\n                            type: 'positive',\n                            title: '–í—ã—Å–æ–∫–∞—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å',\n                            description: `EBITDA –º–∞—Ä–∂–∞ ${margin.toFixed(1)}% —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏.`,\n                            impact: '–°—Ä–µ–¥–Ω–µ–µ'\n                        });\n                    } else if (margin < 15) {\n                        insights.push({\n                            type: 'negative',\n                            title: '–ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å',\n                            description: `EBITDA –º–∞—Ä–∂–∞ ${margin.toFixed(1)}% –Ω–∏–∂–µ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤.`,\n                            impact: '–í—ã—Å–æ–∫–æ–µ'\n                        });\n                    }\n                }\n                \n                // Cash insights\n                if (data.kpi.cashRunwayMonths) {\n                    var runway = data.kpi.cashRunwayMonths;\n                    if (runway < 3) {\n                        insights.push({\n                            type: 'negative',\n                            title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏',\n                            description: `–û—Å—Ç–∞—Ç–∫–∞ –î–° —Ö–≤–∞—Ç–∏—Ç –Ω–∞ ${runway.toFixed(1)} –º–µ—Å. –ù–µ–æ–±—Ö–æ–¥–∏–º—ã —Å—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã.`,\n                            impact: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ'\n                        });\n                    } else if (runway > 12) {\n                        insights.push({\n                            type: 'neutral',\n                            title: '–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å',\n                            description: `–û—Å—Ç–∞—Ç–∫–∞ –î–° —Ö–≤–∞—Ç–∏—Ç –Ω–∞ ${runway.toFixed(1)} –º–µ—Å. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏.`,\n                            impact: '–°—Ä–µ–¥–Ω–µ–µ'\n                        });\n                    }\n                }\n            }\n            \n            // Seasonal insights\n            var seasonalInsight = this.analyzeSeasonality(data);\n            if (seasonalInsight) {\n                insights.push(seasonalInsight);\n            }\n            \n            return insights;\n        },\n        \n        // Analyze seasonality patterns\n        analyzeSeasonality: function(data) {\n            if (!data.timeSeries || !data.timeSeries.revenue || !data.timeSeries.revenue.fact) {\n                return null;\n            }\n            \n            var revenue = data.timeSeries.revenue.fact;\n            var currentMonth = new Date().getMonth();\n            \n            // Simple seasonality detection (Q4 is typically strongest)\n            if (currentMonth >= 9) { // Q4\n                var q4Avg = revenue.slice(-3).reduce(function(a, b) { return a + b; }) / 3;\n                var yearAvg = revenue.reduce(function(a, b) { return a + b; }) / revenue.length;\n                \n                if (q4Avg > yearAvg * 1.2) {\n                    return {\n                        type: 'neutral',\n                        title: '–°–µ–∑–æ–Ω–Ω—ã–π —Ä–æ—Å—Ç –≤ Q4',\n                        description: '–í—ã—Ä—É—á–∫–∞ Q4 –Ω–∞ 20%+ –≤—ã—à–µ –≥–æ–¥–æ–≤–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ. –¢–∏–ø–∏—á–Ω–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞.',\n                        impact: '–ù–∏–∑–∫–æ–µ'\n                    };\n                }\n            }\n            \n            return null;\n        },\n        \n        // Load forecasts\n        loadForecasts: function() {\n            var data = window.DataManager ? window.DataManager.getData() : null;\n            if (!data) return;\n            \n            var forecasts = this.generateForecasts(data);\n            var container = document.getElementById('forecasts-list');\n            \n            container.innerHTML = forecasts.map(function(forecast) {\n                return `\n                    <div class=\"forecast-item\">\n                        <div class=\"forecast-metric\">${forecast.metric}</div>\n                        <div class=\"forecast-period\">${forecast.period}</div>\n                        <div class=\"forecast-value\">${forecast.value}</div>\n                        <div class=\"forecast-confidence\">–¢–æ—á–Ω–æ—Å—Ç—å: ${forecast.confidence}%</div>\n                        <div class=\"forecast-method\">${forecast.method}</div>\n                    </div>\n                `;\n            }).join('');\n        },\n        \n        // Generate forecasts\n        generateForecasts: function(data) {\n            var forecasts = [];\n            \n            if (data.timeSeries && data.timeSeries.revenue && data.timeSeries.revenue.fact) {\n                var revenue = data.timeSeries.revenue.fact;\n                \n                // Simple linear trend forecast\n                var trend = this.calculateLinearTrend(revenue);\n                var nextMonthRevenue = revenue[revenue.length - 1] + trend;\n                \n                forecasts.push({\n                    metric: '–í—ã—Ä—É—á–∫–∞',\n                    period: '–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü',\n                    value: this.formatMoney(nextMonthRevenue),\n                    confidence: this.calculateConfidence(revenue),\n                    method: '–õ–∏–Ω–µ–π–Ω—ã–π —Ç—Ä–µ–Ω–¥'\n                });\n                \n                // Quarter forecast\n                var quarterRevenue = nextMonthRevenue * 3;\n                forecasts.push({\n                    metric: '–í—ã—Ä—É—á–∫–∞',\n                    period: '–°–ª–µ–¥—É—é—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª',\n                    value: this.formatMoney(quarterRevenue),\n                    confidence: Math.max(50, this.calculateConfidence(revenue) - 15),\n                    method: '–≠–∫—Å—Ç—Ä–∞–ø–æ–ª—è—Ü–∏—è —Ç—Ä–µ–Ω–¥–∞'\n                });\n            }\n            \n            // EBITDA forecast based on margin trends\n            if (data.timeSeries && data.timeSeries.margins) {\n                var margins = data.timeSeries.margins.ebitda;\n                if (margins && margins.length > 0) {\n                    var avgMargin = margins.reduce(function(a, b) { return a + b; }) / margins.length;\n                    var forecastEbitda = (revenue[revenue.length - 1] + trend) * (avgMargin / 100);\n                    \n                    forecasts.push({\n                        metric: 'EBITDA',\n                        period: '–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü',\n                        value: this.formatMoney(forecastEbitda),\n                        confidence: 75,\n                        method: '–ù–∞ –æ—Å–Ω–æ–≤–µ –º–∞—Ä–∂–∏'\n                    });\n                }\n            }\n            \n            // Cash flow forecast\n            if (data.kpi && data.kpi.cashEnd) {\n                var burnRate = this.estimateBurnRate(data);\n                var monthsRunway = data.kpi.cashEnd / burnRate;\n                \n                forecasts.push({\n                    metric: '–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å',\n                    period: '–ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –î–°',\n                    value: monthsRunway.toFixed(1) + ' –º–µ—Å',\n                    confidence: 85,\n                    method: '–ê–Ω–∞–ª–∏–∑ burn rate'\n                });\n            }\n            \n            return forecasts;\n        },\n        \n        // Calculate linear trend\n        calculateLinearTrend: function(data) {\n            if (data.length < 2) return 0;\n            \n            var n = data.length;\n            var sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;\n            \n            for (var i = 0; i < n; i++) {\n                sumX += i;\n                sumY += data[i];\n                sumXY += i * data[i];\n                sumXX += i * i;\n            }\n            \n            var slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);\n            return slope || 0;\n        },\n        \n        // Calculate forecast confidence\n        calculateConfidence: function(data) {\n            if (data.length < 3) return 50;\n            \n            var trend = this.calculateLinearTrend(data);\n            var variance = this.calculateVariance(data);\n            var cv = Math.sqrt(variance) / this.average(data);\n            \n            // Lower coefficient of variation = higher confidence\n            var confidence = Math.max(50, Math.min(95, 100 - cv * 100));\n            return Math.round(confidence);\n        },\n        \n        // Calculate variance\n        calculateVariance: function(data) {\n            var avg = this.average(data);\n            var squaredDiffs = data.map(function(val) {\n                return Math.pow(val - avg, 2);\n            });\n            return this.average(squaredDiffs);\n        },\n        \n        // Calculate average\n        average: function(data) {\n            return data.reduce(function(a, b) { return a + b; }) / data.length;\n        },\n        \n        // Estimate monthly burn rate\n        estimateBurnRate: function(data) {\n            if (data.timeSeries && data.timeSeries.revenue && data.kpi && data.kpi.ebitda) {\n                var avgRevenue = this.average(data.timeSeries.revenue.fact || []);\n                var ebitdaMargin = data.kpi.ebitda / avgRevenue;\n                \n                // Estimate operating cash flow\n                var operatingCF = avgRevenue * ebitdaMargin;\n                \n                // Assume some capex and working capital changes\n                var totalCF = operatingCF * 0.8; // 80% conversion\n                \n                return Math.max(1000000, Math.abs(totalCF)); // At least 1M burn rate\n            }\n            \n            return 5000000; // Default 5M monthly burn\n        },\n        \n        // Load correlations analysis\n        loadCorrelations: function() {\n            var data = window.DataManager ? window.DataManager.getData() : null;\n            if (!data) return;\n            \n            var correlations = this.findCorrelations(data);\n            var container = document.getElementById('correlations-list');\n            \n            container.innerHTML = correlations.map(function(corr) {\n                var strength = Math.abs(corr.coefficient);\n                var strengthText = strength > 0.7 ? '–°–∏–ª—å–Ω–∞—è' : \n                                 strength > 0.4 ? '–£–º–µ—Ä–µ–Ω–Ω–∞—è' : '–°–ª–∞–±–∞—è';\n                var direction = corr.coefficient > 0 ? '–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è' : '–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è';\n                \n                return `\n                    <div class=\"correlation-item\">\n                        <div class=\"correlation-metrics\">${corr.metric1} ‚Üî ${corr.metric2}</div>\n                        <div class=\"correlation-strength\">${strengthText} ${direction}</div>\n                        <div class=\"correlation-coefficient\">r = ${corr.coefficient.toFixed(3)}</div>\n                        <div class=\"correlation-insight\">${corr.insight}</div>\n                    </div>\n                `;\n            }).join('');\n        },\n        \n        // Find correlations between metrics\n        findCorrelations: function(data) {\n            var correlations = [];\n            \n            if (data.timeSeries && data.timeSeries.revenue && data.timeSeries.margins) {\n                var revenue = data.timeSeries.revenue.fact || [];\n                var margins = data.timeSeries.margins.ebitda || [];\n                \n                if (revenue.length === margins.length && revenue.length > 2) {\n                    var correlation = this.calculateCorrelation(revenue, margins);\n                    \n                    correlations.push({\n                        metric1: '–í—ã—Ä—É—á–∫–∞',\n                        metric2: 'EBITDA –º–∞—Ä–∂–∞',\n                        coefficient: correlation,\n                        insight: this.getCorrelationInsight('revenue', 'margin', correlation)\n                    });\n                }\n            }\n            \n            // Mock additional correlations for demonstration\n            correlations.push({\n                metric1: '–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å',\n                metric2: '–í—ã—Ä—É—á–∫–∞',\n                coefficient: 0.65,\n                insight: '–í—ã—Ä—É—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–º–µ—Ä–µ–Ω–Ω—É—é —Å–µ–∑–æ–Ω–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å'\n            });\n            \n            correlations.push({\n                metric1: '–ú–∞—Ä–∂–∞',\n                metric2: '–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',\n                coefficient: -0.78,\n                insight: '–†–æ—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å'\n            });\n            \n            return correlations;\n        },\n        \n        // Calculate Pearson correlation coefficient\n        calculateCorrelation: function(x, y) {\n            var n = x.length;\n            if (n !== y.length || n === 0) return 0;\n            \n            var sumX = this.sum(x);\n            var sumY = this.sum(y);\n            var sumXY = this.sum(x.map(function(xi, i) { return xi * y[i]; }));\n            var sumXX = this.sum(x.map(function(xi) { return xi * xi; }));\n            var sumYY = this.sum(y.map(function(yi) { return yi * yi; }));\n            \n            var numerator = n * sumXY - sumX * sumY;\n            var denominator = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));\n            \n            return denominator === 0 ? 0 : numerator / denominator;\n        },\n        \n        // Sum array values\n        sum: function(arr) {\n            return arr.reduce(function(a, b) { return a + b; }, 0);\n        },\n        \n        // Get correlation insight\n        getCorrelationInsight: function(metric1, metric2, correlation) {\n            if (Math.abs(correlation) > 0.7) {\n                return correlation > 0 ? \n                    '–°–∏–ª—å–Ω–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å - –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Ç—É—Ç/–ø–∞–¥–∞—é—Ç –≤–º–µ—Å—Ç–µ' :\n                    '–°–∏–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å - –º–µ—Ç—Ä–∏–∫–∏ –∏–∑–º–µ–Ω—è—é—Ç—Å—è –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö';\n            } else if (Math.abs(correlation) > 0.4) {\n                return '–£–º–µ—Ä–µ–Ω–Ω–∞—è —Å–≤—è–∑—å –º–µ–∂–¥—É –º–µ—Ç—Ä–∏–∫–∞–º–∏';\n            } else {\n                return '–°–ª–∞–±–∞—è —Å–≤—è–∑—å - –º–µ—Ç—Ä–∏–∫–∏ –∏–∑–º–µ–Ω—è—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ';\n            }\n        },\n        \n        // Load risk alerts\n        loadRiskAlerts: function() {\n            var data = window.DataManager ? window.DataManager.getData() : null;\n            if (!data) return;\n            \n            var risks = this.assessRisks(data);\n            var container = document.getElementById('alerts-list');\n            \n            container.innerHTML = risks.map(function(risk) {\n                var severityClass = risk.severity.toLowerCase();\n                var iconMap = {\n                    '–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π': 'üî¥',\n                    '–≤—ã—Å–æ–∫–∏–π': 'üü†',\n                    '—Å—Ä–µ–¥–Ω–∏–π': 'üü°',\n                    '–Ω–∏–∑–∫–∏–π': 'üü¢'\n                };\n                \n                return `\n                    <div class=\"risk-item ${severityClass}\">\n                        <div class=\"risk-icon\">${iconMap[risk.severity.toLowerCase()]}</div>\n                        <div class=\"risk-content\">\n                            <div class=\"risk-title\">${risk.title}</div>\n                            <div class=\"risk-description\">${risk.description}</div>\n                            <div class=\"risk-recommendation\">${risk.recommendation}</div>\n                            <div class=\"risk-severity\">–£—Ä–æ–≤–µ–Ω—å: ${risk.severity}</div>\n                        </div>\n                    </div>\n                `;\n            }).join('');\n        },\n        \n        // Assess business risks\n        assessRisks: function(data) {\n            var risks = [];\n            \n            if (data.kpi) {\n                // Revenue risk\n                if (data.kpi.revenue && data.kpi.revenue.momChange < -this.alertThresholds.revenueDecline * 100) {\n                    risks.push({\n                        title: '–ü–∞–¥–µ–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏',\n                        description: `–í—ã—Ä—É—á–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç—Å—è —É–∂–µ ${Math.abs(data.kpi.revenue.momChange).toFixed(1)}% –º/–º`,\n                        recommendation: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã: –ø–æ—Ç–µ—Ä—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å',\n                        severity: '–í—ã—Å–æ–∫–∏–π'\n                    });\n                }\n                \n                // Margin risk\n                if (data.kpi.margins && data.kpi.margins.ebitda < 15) {\n                    risks.push({\n                        title: '–ù–∏–∑–∫–∞—è –º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å',\n                        description: `EBITDA –º–∞—Ä–∂–∞ ${data.kpi.margins.ebitda.toFixed(1)}% –Ω–∏–∂–µ –∑–¥–æ—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è`,\n                        recommendation: '–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∑–∞—Ç—Ä–∞—Ç, –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É',\n                        severity: '–°—Ä–µ–¥–Ω–∏–π'\n                    });\n                }\n                \n                // Liquidity risk\n                if (data.kpi.cashRunwayMonths < this.alertThresholds.cashLow / 30) {\n                    risks.push({\n                        title: '–†–∏—Å–∫ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏',\n                        description: `–û—Å—Ç–∞—Ç–∫–∞ –¥–µ–Ω–µ–∂–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ ${data.kpi.cashRunwayMonths.toFixed(1)} –º–µ—Å`,\n                        recommendation: '–£—Å–∫–æ—Ä–∏—Ç—å —Å–±–æ—Ä –¥–µ–±–∏—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–∏–≤–ª–µ—á—å —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ',\n                        severity: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π'\n                    });\n                }\n            }\n            \n            // AR risk\n            if (data.arAging && data.arAging.buckets) {\n                var total = data.arAging.totalAR;\n                var overdue = (data.arAging.buckets['61-90'] || 0) + (data.arAging.buckets['90+'] || 0);\n                var overduePercent = (overdue / total) * 100;\n                \n                if (overduePercent > 20) {\n                    risks.push({\n                        title: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –¥–µ–±–∏—Ç–æ—Ä–∫–∞',\n                        description: `${overduePercent.toFixed(1)}% –¥–µ–±–∏—Ç–æ—Ä–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ —Å–≤—ã—à–µ 60 –¥–Ω–µ–π`,\n                        recommendation: '–£—Å–∏–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –¥–æ–ª–∂–Ω–∏–∫–∞–º–∏, —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤ –ø–æ–¥ –æ–±–µ—Å—Ü–µ–Ω–µ–Ω–∏–µ',\n                        severity: '–í—ã—Å–æ–∫–∏–π'\n                    });\n                }\n            }\n            \n            // Market risk (example)\n            risks.push({\n                title: '–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤',\n                description: '–¢–æ–ø-3 –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç 65% –≤—ã—Ä—É—á–∫–∏',\n                recommendation: '–î–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –±–∞–∑—É –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞',\n                severity: '–°—Ä–µ–¥–Ω–∏–π'\n            });\n            \n            return risks;\n        },\n        \n        // Show trend analysis for specific KPI\n        showTrendAnalysis: function(kpiCard) {\n            var cardClass = Array.from(kpiCard.classList).find(function(cls) {\n                return cls.startsWith('kpi-');\n            });\n            \n            if (!cardClass) return;\n            \n            var metricName = cardClass.replace('kpi-', '');\n            var analysis = this.analyzeTrend(metricName);\n            \n            this.showTrendPopup(metricName, analysis);\n        },\n        \n        // Analyze trend for specific metric\n        analyzeTrend: function(metricName) {\n            var data = window.DataManager ? window.DataManager.getData() : null;\n            if (!data) return null;\n            \n            // Get historical data for the metric\n            var historicalData = this.getHistoricalData(data, metricName);\n            if (!historicalData || historicalData.length < 3) {\n                return {\n                    trend: 'insufficient-data',\n                    description: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–∞',\n                    confidence: 0\n                };\n            }\n            \n            var trend = this.calculateLinearTrend(historicalData);\n            var variance = this.calculateVariance(historicalData);\n            var cv = Math.sqrt(variance) / Math.abs(this.average(historicalData));\n            \n            return {\n                trend: trend > 0 ? 'upward' : trend < 0 ? 'downward' : 'stable',\n                slope: trend,\n                variance: variance,\n                cv: cv,\n                confidence: this.calculateConfidence(historicalData),\n                description: this.describeTrend(trend, cv),\n                forecast: this.forecastNextPeriod(historicalData, trend)\n            };\n        },\n        \n        // Get historical data for metric\n        getHistoricalData: function(data, metricName) {\n            switch (metricName) {\n                case 'revenue':\n                    return data.timeSeries && data.timeSeries.revenue ? \n                           data.timeSeries.revenue.fact : null;\n                case 'ebitda':\n                    // Calculate EBITDA from revenue and margin\n                    if (data.timeSeries && data.timeSeries.revenue && data.timeSeries.margins) {\n                        var revenue = data.timeSeries.revenue.fact || [];\n                        var margins = data.timeSeries.margins.ebitda || [];\n                        return revenue.map(function(rev, i) {\n                            return rev * ((margins[i] || 0) / 100);\n                        });\n                    }\n                    return null;\n                case 'cash':\n                    // Mock cash flow data\n                    return [45600000, 42300000, 48100000, 44500000, 46200000];\n                case 'margin':\n                    return data.timeSeries && data.timeSeries.margins ? \n                           data.timeSeries.margins.ebitda : null;\n                default:\n                    return null;\n            }\n        },\n        \n        // Describe trend in human terms\n        describeTrend: function(slope, cv) {\n            var trendDirection = slope > 0 ? '—Ä–∞—Å—Ç—É—â–∏–π' : slope < 0 ? '–ø–∞–¥–∞—é—â–∏–π' : '—Å—Ç–∞–±–∏–ª—å–Ω—ã–π';\n            var volatility = cv > 0.2 ? '–≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é' : \n                            cv > 0.1 ? '—É–º–µ—Ä–µ–Ω–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é' : '–Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é';\n            \n            return `${trendDirection} —Ç—Ä–µ–Ω–¥ —Å ${volatility}`;\n        },\n        \n        // Forecast next period value\n        forecastNextPeriod: function(data, trend) {\n            if (!data || data.length === 0) return null;\n            \n            var lastValue = data[data.length - 1];\n            return lastValue + trend;\n        },\n        \n        // Show trend analysis popup\n        showTrendPopup: function(metricName, analysis) {\n            var popup = document.createElement('div');\n            popup.className = 'trend-popup';\n            popup.style.cssText = `\n                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);\n                background: white; border-radius: 12px; padding: 20px; z-index: 1001;\n                box-shadow: 0 8px 25px rgba(0,0,0,0.3); min-width: 350px;\n            `;\n            \n            var metricTitle = {\n                'revenue': '–í—ã—Ä—É—á–∫–∞',\n                'ebitda': 'EBITDA', \n                'cash': '–î–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞',\n                'margin': 'EBITDA –º–∞—Ä–∂–∞'\n            }[metricName] || metricName;\n            \n            popup.innerHTML = `\n                <div class=\"trend-popup-header\">\n                    <h3>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞: ${metricTitle}</h3>\n                    <button onclick=\"this.closest('.trend-popup').remove()\" class=\"close-btn\">√ó</button>\n                </div>\n                <div class=\"trend-popup-content\">\n                    <div class=\"trend-description\">${analysis ? analysis.description : '–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'}</div>\n                    ${analysis && analysis.forecast ? \n                        `<div class=\"trend-forecast\">–ü—Ä–æ–≥–Ω–æ–∑: ${this.formatValue(analysis.forecast, metricName)}</div>` : \n                        ''\n                    }\n                    ${analysis && analysis.confidence ? \n                        `<div class=\"trend-confidence\">–¢–æ—á–Ω–æ—Å—Ç—å: ${analysis.confidence}%</div>` : \n                        ''\n                    }\n                </div>\n            `;\n            \n            document.body.appendChild(popup);\n            \n            // Auto-remove after 5 seconds\n            setTimeout(function() {\n                if (popup.parentNode) {\n                    popup.remove();\n                }\n            }, 5000);\n        },\n        \n        // Format value based on metric type\n        formatValue: function(value, metricName) {\n            switch (metricName) {\n                case 'revenue':\n                case 'ebitda':\n                case 'cash':\n                    return this.formatMoney(value);\n                case 'margin':\n                    return value.toFixed(1) + '%';\n                default:\n                    return value.toString();\n            }\n        },\n        \n        // Format money values\n        formatMoney: function(value) {\n            return (value / 1000000).toFixed(1) + ' –º–ª–Ω ‚ÇΩ';\n        },\n        \n        // Start periodic analysis\n        startPeriodicAnalysis: function() {\n            var self = this;\n            \n            // Run analysis every 5 minutes\n            setInterval(function() {\n                if (document.getElementById('analytics-panel').style.display === 'block') {\n                    self.runFullAnalysis();\n                }\n            }, 300000);\n        },\n        \n        // Invalidate analysis cache\n        invalidateCache: function() {\n            this.analysisCache = {};\n            this.forecastCache = {};\n        }\n    };\n    \n    // Add CSS styles\n    var style = document.createElement('style');\n    style.textContent = `\n        .analytics-btn {\n            border: none; background: var(--panel); padding: 6px 10px;\n            border-radius: 8px; cursor: pointer; font-size: 12px;\n            box-shadow: var(--shadow);\n        }\n        .analytics-btn:hover { background: #f0f0f0; }\n        \n        .analytics-panel {\n            position: fixed; top: 10%; right: 24px; width: 450px;\n            max-height: 80vh; overflow-y: auto; background: white;\n            border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3);\n            z-index: 1000;\n        }\n        \n        .analytics-header {\n            padding: 16px; border-bottom: 1px solid #eee;\n            display: flex; justify-content: space-between; align-items: center;\n        }\n        \n        .analytics-tabs {\n            display: flex; border-bottom: 1px solid #eee;\n        }\n        \n        .analytics-tab {\n            flex: 1; padding: 12px 8px; border: none; background: none;\n            cursor: pointer; font-size: 12px;\n        }\n        \n        .analytics-tab.active {\n            background: #007AFF; color: white;\n        }\n        \n        .analytics-section {\n            display: none; padding: 16px;\n        }\n        \n        .analytics-section.active {\n            display: block;\n        }\n        \n        .insight-item, .forecast-item, .correlation-item, .risk-item {\n            padding: 12px; border-bottom: 1px solid #f0f0f0;\n            display: flex; gap: 12px;\n        }\n        \n        .insight-icon, .risk-icon {\n            font-size: 20px; flex-shrink: 0;\n        }\n        \n        .insight-content, .risk-content {\n            flex: 1;\n        }\n        \n        .insight-title, .risk-title {\n            font-weight: 600; margin-bottom: 4px;\n        }\n        \n        .insight-description, .risk-description {\n            font-size: 13px; color: #666; margin-bottom: 4px;\n        }\n        \n        .insight-impact {\n            font-size: 11px; font-weight: 600; color: #007AFF;\n        }\n        \n        .risk-recommendation {\n            font-size: 12px; background: #f0f8ff; padding: 4px 8px;\n            border-radius: 4px; margin-top: 4px;\n        }\n        \n        .trend-indicator {\n            position: absolute; top: 8px; right: 8px;\n            font-size: 14px; cursor: pointer; opacity: 0.7;\n        }\n        \n        .trend-indicator:hover {\n            opacity: 1; transform: scale(1.2);\n        }\n        \n        .forecast-item {\n            flex-direction: column; gap: 4px;\n        }\n        \n        .forecast-metric {\n            font-weight: 600;\n        }\n        \n        .forecast-value {\n            font-size: 16px; color: #007AFF;\n        }\n        \n        .forecast-confidence {\n            font-size: 11px; color: #666;\n        }\n        \n        .correlation-metrics {\n            font-weight: 600; margin-bottom: 4px;\n        }\n        \n        .correlation-strength {\n            font-size: 12px; color: #007AFF;\n        }\n        \n        .correlation-coefficient {\n            font-family: monospace; font-size: 11px;\n        }\n    `;\n    document.head.appendChild(style);\n    \n    // Export to window\n    window.AdvancedAnalytics = AdvancedAnalytics;\n    \n    // Auto-initialize when DOM is ready\n    document.addEventListener('DOMContentLoaded', function() {\n        setTimeout(function() {\n            AdvancedAnalytics.initialize();\n        }, 2000);\n    });\n    \n})();